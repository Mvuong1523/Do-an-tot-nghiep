### ========================================
### TEST ACCOUNTING AUTOMATION
### ========================================

### 1. Login as Admin
POST http://localhost:8080/api/auth/login
Content-Type: application/json

{
  "email": "admin@example.com",
  "password": "admin123"
}

### Save the token from response
@token = {{login.response.body.data.token}}

### ========================================
### TEST 1: Đơn Hàng COD - Giao Thành Công
### ========================================

### 2. Get all orders to find a CONFIRMED order
GET http://localhost:8080/api/orders/all?status=CONFIRMED
Authorization: Bearer {{token}}

### Save an order ID from the response
@orderId = 1

### 3. Check current transactions for this order (should be empty)
GET http://localhost:8080/api/accounting/transactions?orderId={{orderId}}
Authorization: Bearer {{token}}

### 4. Update order status to DELIVERED (this should trigger automation)
PUT http://localhost:8080/api/orders/{{orderId}}/status
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "status": "DELIVERED"
}

### 5. Check transactions again (should have 2 new transactions)
GET http://localhost:8080/api/accounting/transactions?orderId={{orderId}}
Authorization: Bearer {{token}}

### Expected result:
### - 1 transaction: REVENUE/SALES (order total amount)
### - 1 transaction: EXPENSE/SHIPPING (80% of shipping fee)

### ========================================
### TEST 2: Kiểm Tra Không Tạo Duplicate
### ========================================

### 6. Update order status again to COMPLETED
PUT http://localhost:8080/api/orders/{{orderId}}/status
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "status": "COMPLETED"
}

### 7. Check transactions again (should still have only 2 transactions, no duplicates)
GET http://localhost:8080/api/accounting/transactions?orderId={{orderId}}
Authorization: Bearer {{token}}

### Expected result:
### - Still only 2 transactions (no duplicates created)

### ========================================
### TEST 3: Đơn Hàng Thanh Toán Online
### ========================================

### 8. Create a new order with SEPAY payment method
POST http://localhost:8080/api/orders
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "customerId": 1,
  "shippingAddress": "123 Test Street",
  "province": "Hà Nội",
  "district": "Đống Đa",
  "ward": "Văn Miếu",
  "wardName": "Phường Văn Miếu",
  "address": "123 Test Street",
  "note": "Test order for accounting automation",
  "shippingFee": 30000,
  "paymentMethod": "SEPAY"
}

### Save the new order ID
@newOrderId = {{createOrder.response.body.data.orderId}}

### 9. Simulate payment success (update payment status)
### Note: In real system, this would come from SEPAY webhook
PUT http://localhost:8080/api/orders/{{newOrderId}}/status
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "status": "CONFIRMED"
}

### 10. Check transactions for the new order
GET http://localhost:8080/api/accounting/transactions?orderId={{newOrderId}}
Authorization: Bearer {{token}}

### Expected result:
### - 1 transaction: REVENUE/SALES (order total)
### - 1 transaction: EXPENSE/PAYMENT_FEE (2% of order total)

### ========================================
### TEST 4: Báo Cáo Lãi Lỗ
### ========================================

### 11. Generate profit/loss report
POST http://localhost:8080/api/accounting/advanced-reports/profit-loss
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "startDate": "2023-01-01",
  "endDate": "2025-12-31"
}

### Expected result:
### - salesRevenue: Sum of all REVENUE/SALES transactions
### - shippingCosts: Sum of all EXPENSE/SHIPPING transactions
### - paymentFees: Sum of all EXPENSE/PAYMENT_FEE transactions
### - grossProfit: salesRevenue - (shippingCosts + paymentFees)
### - netProfit: grossProfit - VAT

### ========================================
### TEST 5: Kiểm Tra Logs
### ========================================

### Check backend console logs for:
### - "Published OrderStatusChangedEvent for order: ..."
### - "Handling order status change: ... -> ... for order ..."
### - "Created REVENUE transaction: ... VND for order ..."
### - "Created SHIPPING EXPENSE transaction: ... VND for order ..."
### - "Created PAYMENT FEE transaction: ... VND for order ..."
### - "✅ Created accounting transactions for order ..."

### ========================================
### TEST 6: Kiểm Tra Database
### ========================================

### Run this SQL query to check transactions:
### SELECT * FROM financial_transactions WHERE order_id = {{orderId}};

### Expected columns:
### - id
### - type (REVENUE or EXPENSE)
### - category (SALES, SHIPPING, PAYMENT_FEE)
### - amount
### - order_id
### - description
### - transaction_date
### - created_by (should be "SYSTEM")

### ========================================
### CLEANUP (Optional)
### ========================================

### Delete test transactions
DELETE http://localhost:8080/api/accounting/transactions/{{transactionId}}
Authorization: Bearer {{token}}
